#!/bin/bash

# HIDE - Invisible File/Folder Management System
# Version: 2.0.0 (ULTIMATE EDITION)
# Features: matrix search, stats, duplicate detection, trap logging

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

# Base directory for hidden storage
HIDE_BASE="$HOME/.local/.cache/.system"
HIDE_STORAGE="$HIDE_BASE/.storage"
HIDE_REGISTRY="$HIDE_BASE/.registry.enc"
HIDE_TEMP="$HIDE_BASE/.temp"
HIDE_NOTEPAD_DIR="$HIDE_BASE/.notepad"
HIDE_TRAP_LOG="$HIDE_BASE/.trap_log"

# Initialize the hide system
init_hide_system() {
    if [ ! -d "$HIDE_BASE" ]; then
        mkdir -p "$HIDE_BASE"
        chattr +i "$HIDE_BASE" 2>/dev/null || true
    fi
    
    if [ ! -d "$HIDE_STORAGE" ]; then
        mkdir -p "$HIDE_STORAGE"
    fi
    
    if [ ! -d "$HIDE_TEMP" ]; then
        mkdir -p "$HIDE_TEMP"
    fi
    
    if [ ! -d "$HIDE_NOTEPAD_DIR" ]; then
        mkdir -p "$HIDE_NOTEPAD_DIR"
    fi
    
    if [ ! -f "$HIDE_REGISTRY" ]; then
        echo "[]" | base64 > "$HIDE_REGISTRY"
    fi
    
    if [ ! -f "$HIDE_TRAP_LOG" ]; then
        echo "[]" | base64 > "$HIDE_TRAP_LOG"
    fi
}

# Encode/Decode registry (simple base64 encryption)
encode_registry() {
    echo "$1" | base64
}

decode_registry() {
    echo "$1" | base64 -d
}

# Read registry
read_registry() {
    if [ -f "$HIDE_REGISTRY" ]; then
        decode_registry "$(cat "$HIDE_REGISTRY")"
    else
        echo "[]"
    fi
}

# Write registry
write_registry() {
    encode_registry "$1" > "$HIDE_REGISTRY"
}

# Generate unique ID
generate_id() {
    echo "$(date +%s)_$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 16 | head -n 1)"
}

# Add entry to registry
add_to_registry() {
    local name="$1"
    local type="$2"
    local editor="$3"
    local hidden_path="$4"
    local locked="${5:-false}"
    local password="${6:-}"
    local trapped="${7:-false}"
    
    local registry=$(read_registry)
    local id=$(generate_id)
    
    local entry="{\"id\":\"$id\",\"name\":\"$name\",\"type\":\"$type\",\"editor\":\"$editor\",\"path\":\"$hidden_path\",\"locked\":$locked,\"password\":\"$password\",\"trapped\":$trapped,\"created\":\"$(date)\"}"
    
    if [ "$registry" = "[]" ]; then
        registry="[$entry]"
    else
        registry="${registry%]},${entry}]"
    fi
    
    write_registry "$registry"
    echo "$id"
}

# Get entry from registry
get_from_registry() {
    local name="$1"
    local registry=$(read_registry)
    
    echo "$registry" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    for item in data:
        if item['name'] == '$name':
            print(json.dumps(item))
            sys.exit(0)
except:
    pass
"
}

# Remove entry from registry
remove_from_registry() {
    local name="$1"
    local registry=$(read_registry)
    
    local new_registry=$(echo "$registry" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    filtered = [item for item in data if item['name'] != '$name']
    print(json.dumps(filtered))
except:
    print('[]')
")
    
    write_registry "$new_registry"
}

# Update entry in registry
update_registry_entry() {
    local old_name="$1"
    local new_name="$2"
    local registry=$(read_registry)
    
    local new_registry=$(echo "$registry" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    for item in data:
        if item['name'] == '$old_name':
            item['name'] = '$new_name'
    print(json.dumps(data))
except:
    print('[]')
")
    
    write_registry "$new_registry"
}

# Lock entry in registry
lock_registry_entry() {
    local name="$1"
    local password="$2"
    local registry=$(read_registry)
    
    local hashed_password=$(echo -n "$password" | sha256sum | awk '{print $1}')
    
    local new_registry=$(echo "$registry" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    for item in data:
        if item['name'] == '$name':
            item['locked'] = True
            item['password'] = '$hashed_password'
    print(json.dumps(data))
except:
    print('[]')
")
    
    write_registry "$new_registry"
}

# Set trap on entry
set_trap_registry() {
    local name="$1"
    local registry=$(read_registry)
    
    local new_registry=$(echo "$registry" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    for item in data:
        if item['name'] == '$name':
            item['trapped'] = True
    print(json.dumps(data))
except:
    print('[]')
")
    
    write_registry "$new_registry"
}

# Log trap access
log_trap_access() {
    local name="$1"
    local timestamp="$(date '+%Y-%m-%d %H:%M:%S')"
    local user="$USER"
    local terminal="$(tty)"
    
    local trap_log=$(cat "$HIDE_TRAP_LOG" 2>/dev/null | base64 -d || echo "[]")
    local log_entry="{\"name\":\"$name\",\"timestamp\":\"$timestamp\",\"user\":\"$user\",\"terminal\":\"$terminal\"}"
    
    if [ "$trap_log" = "[]" ]; then
        trap_log="[$log_entry]"
    else
        trap_log="${trap_log%]},${log_entry}]"
    fi
    
    echo "$trap_log" | base64 > "$HIDE_TRAP_LOG"
    
    # Send alert
    echo -e "${RED}âš ï¸  TRAP ALERT: '$name' accessed by $user at $timestamp${NC}" >&2
}

# Check password
check_password() {
    local name="$1"
    local password="$2"
    local entry=$(get_from_registry "$name")
    
    if [ -z "$entry" ]; then
        return 1
    fi
    
    local stored_hash=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin).get('password', ''))")
    local input_hash=$(echo -n "$password" | sha256sum | awk '{print $1}')
    
    [ "$stored_hash" = "$input_hash" ]
}

# Get file size
get_size() {
    local path="$1"
    if [ -f "$path" ]; then
        du -sh "$path" 2>/dev/null | awk '{print $1}'
    elif [ -d "$path" ]; then
        du -sh "$path" 2>/dev/null | awk '{print $1}'
    else
        echo "0B"
    fi
}

# Get file hash
get_hash() {
    local path="$1"
    if [ -f "$path" ]; then
        sha256sum "$path" 2>/dev/null | awk '{print $1}'
    else
        echo ""
    fi
}

# Create hidden item
create_hidden_item() {
    echo -e "${CYAN}What do you want to hide?${NC}"
    echo "1) File"
    echo "2) Folder"
    read -p "Choose (1 or 2): " choice
    
    case $choice in
        1) local type="file" ;;
        2) local type="folder" ;;
        *) echo -e "${RED}Invalid choice${NC}"; exit 1 ;;
    esac
    
    echo -e "${CYAN}Editor type:${NC}"
    echo "1) nano (text editor)"
    echo "2) normal (hidden notepad)"
    read -p "Choose (1 or 2): " editor_choice
    
    case $editor_choice in
        1) local editor="nano" ;;
        2) local editor="normal" ;;
        *) echo -e "${RED}Invalid choice${NC}"; exit 1 ;;
    esac
    
    read -p "Enter name: " name
    
    if [ -z "$name" ]; then
        echo -e "${RED}Name cannot be empty${NC}"
        exit 1
    fi
    
    if [ -n "$(get_from_registry "$name")" ]; then
        echo -e "${RED}Item '$name' already exists${NC}"
        exit 1
    fi
    
    local hidden_id=$(generate_id)
    local hidden_path="$HIDE_STORAGE/$hidden_id"
    
    if [ "$type" = "file" ]; then
        touch "$hidden_path"
    else
        mkdir -p "$hidden_path"
    fi
    
    add_to_registry "$name" "$type" "$editor" "$hidden_path" "false" "" "false"
    
    echo -e "${GREEN}âœ“ Hidden $type '$name' created successfully${NC}"
    echo -e "${YELLOW}Use 'hide open $name' to access it${NC}"
}

# List hidden items
list_hidden_items() {
    local filter="$1"
    local registry=$(read_registry)
    
    if [ "$registry" = "[]" ]; then
        echo -e "${YELLOW}No hidden items found${NC}"
        return
    fi
    
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘           HIDDEN ITEMS REGISTRY                            â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    echo "$registry" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    filter_type = '$filter'
    
    for item in data:
        if filter_type == 'all' or item['type'] == filter_type:
            locked = 'ğŸ”’' if item.get('locked', False) else 'ğŸ”“'
            trapped = 'âš ï¸ ' if item.get('trapped', False) else ''
            print(f\"  {locked} {trapped}{item['name']}\")
            print(f\"     Type: {item['type']}\")
            print(f\"     Editor: {item['editor']}\")
            print(f\"     Created: {item['created']}\")
            print()
except Exception as e:
    print(f'Error: {e}')
"
}

# Matrix search - search by keyword in names and content
matrix_search() {
    local keyword="$1"
    
    if [ -z "$keyword" ]; then
        echo -e "${RED}Usage: hide matrix <keyword>${NC}"
        exit 1
    fi
    
    local registry=$(read_registry)
    
    if [ "$registry" = "[]" ]; then
        echo -e "${YELLOW}No hidden items found${NC}"
        return
    fi
    
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘        MATRIX SEARCH: '$keyword'                            ${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    local found=0
    
    echo "$registry" | python3 -c "
import sys, json, os, re

keyword = '$keyword'.lower()
data = json.load(sys.stdin)

print('\033[1;33mSearching in names and content...\033[0m\n')

for item in data:
    name = item['name']
    path = item['path']
    item_type = item['type']
    matched = False
    match_reason = []
    
    # Check name
    if keyword in name.lower():
        matched = True
        match_reason.append('name')
    
    # Check content for files
    if item_type == 'file' and os.path.exists(path):
        try:
            with open(path, 'r', errors='ignore') as f:
                content = f.read().lower()
                if keyword in content:
                    matched = True
                    match_reason.append('content')
                    
                    # Find context
                    lines = content.split('\n')
                    for i, line in enumerate(lines):
                        if keyword in line:
                            match_reason.append(f'line {i+1}')
                            break
        except:
            pass
    
    if matched:
        # Color coding
        if item_type == 'file':
            color = '\033[0;35m'  # Purple
            icon = 'ğŸ“„'
        else:
            color = '\033[0;31m'  # Red
            icon = 'ğŸ“'
        
        print(f\"{color}{icon} {name}\033[0m\")
        print(f\"   Type: {item_type}\")
        print(f\"   Match: {', '.join(match_reason)}\")
        print()
" && found=1
    
    if [ $found -eq 0 ]; then
        echo -e "${YELLOW}No matches found for '$keyword'${NC}"
    fi
}

# Show statistics
show_stats() {
    local registry=$(read_registry)
    
    if [ "$registry" = "[]" ]; then
        echo -e "${YELLOW}No hidden items found${NC}"
        return
    fi
    
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘                  HIDDEN STORAGE STATS                      â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    echo "$registry" | python3 -c "
import sys, json, os, subprocess

data = json.load(sys.stdin)

total_files = sum(1 for item in data if item['type'] == 'file')
total_folders = sum(1 for item in data if item['type'] == 'folder')
locked_items = sum(1 for item in data if item.get('locked', False))
trapped_items = sum(1 for item in data if item.get('trapped', False))

print(f'\033[1;36mOVERVIEW:\033[0m')
print(f'  Total Items: {len(data)}')
print(f'  Files: {total_files}')
print(f'  Folders: {total_folders}')
print(f'  Locked: {locked_items}')
print(f'  Trapped: {trapped_items}')
print()

print(f'\033[1;36mITEM DETAILS:\033[0m')
for item in data:
    name = item['name']
    path = item['path']
    item_type = item['type']
    
    # Get size
    try:
        if os.path.exists(path):
            result = subprocess.run(['du', '-sh', path], capture_output=True, text=True)
            size = result.stdout.split()[0] if result.stdout else '0B'
        else:
            size = 'N/A'
    except:
        size = 'N/A'
    
    # Color code
    if item_type == 'file':
        color = '\033[0;35m'  # Purple
        icon = 'ğŸ“„'
    else:
        color = '\033[0;31m'  # Red
        icon = 'ğŸ“'
    
    locked = 'ğŸ”’' if item.get('locked', False) else ''
    trapped = 'âš ï¸ ' if item.get('trapped', False) else ''
    
    print(f'{color}{icon} {name}{locked}{trapped}\033[0m')
    print(f'   Size: {size}')
    print(f'   Created: {item[\"created\"]}')
    print()
"
}

# Find duplicate files
find_duplicates() {
    local registry=$(read_registry)
    
    if [ "$registry" = "[]" ]; then
        echo -e "${YELLOW}No hidden items found${NC}"
        return
    fi
    
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘              DUPLICATE FILE DETECTION                      â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    echo "$registry" | python3 -c "
import sys, json, os, hashlib
from collections import defaultdict

data = json.load(sys.stdin)
files = [item for item in data if item['type'] == 'file']

if not files:
    print('\033[1;33mNo files to check\033[0m')
    sys.exit(0)

print('\033[1;33mCalculating file hashes...\033[0m\n')

hash_map = defaultdict(list)

for item in files:
    path = item['path']
    name = item['name']
    
    if os.path.exists(path) and os.path.isfile(path):
        try:
            with open(path, 'rb') as f:
                file_hash = hashlib.sha256(f.read()).hexdigest()
                hash_map[file_hash].append(name)
        except:
            pass

duplicates = {h: names for h, names in hash_map.items() if len(names) > 1}

if duplicates:
    print(f'\033[1;31mFound {len(duplicates)} duplicate groups:\033[0m\n')
    for file_hash, names in duplicates.items():
        print(f'\033[0;35mğŸ“„ Duplicate Group (hash: {file_hash[:16]}...):\033[0m')
        for name in names:
            print(f'   - {name}')
        print()
else:
    print('\033[1;32mâœ“ No duplicates found\033[0m')
"
}

# Set trap on item
set_trap() {
    local name="$1"
    
    if [ -z "$name" ]; then
        echo -e "${RED}Usage: hide trap <name>${NC}"
        exit 1
    fi
    
    local entry=$(get_from_registry "$name")
    
    if [ -z "$entry" ]; then
        echo -e "${RED}Item '$name' not found${NC}"
        exit 1
    fi
    
    set_trap_registry "$name"
    
    echo -e "${GREEN}âœ“ Trap set on '$name'${NC}"
    echo -e "${YELLOW}Access attempts will be logged and alerted${NC}"
}

# Show hidden item location
show_hidden_item() {
    local name="$1"
    local entry=$(get_from_registry "$name")
    
    if [ -z "$entry" ]; then
        echo -e "${RED}Item '$name' not found${NC}"
        exit 1
    fi
    
    # Check if trapped
    local is_trapped=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin).get('trapped', False))")
    if [ "$is_trapped" = "True" ]; then
        log_trap_access "$name"
    fi
    
    local is_locked=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin).get('locked', False))")
    
    if [ "$is_locked" = "True" ]; then
        echo -e "${RED}Item '$name' is locked. Use 'hide enterKey $name' to unlock${NC}"
        exit 1
    fi
    
    local path=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['path'])")
    
    echo -e "${GREEN}Hidden location: ${BLUE}$path${NC}"
}

# Read hidden file content
read_hidden_file() {
    local name="$1"
    local entry=$(get_from_registry "$name")
    
    if [ -z "$entry" ]; then
        echo -e "${RED}Item '$name' not found${NC}"
        exit 1
    fi
    
    # Check if trapped
    local is_trapped=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin).get('trapped', False))")
    if [ "$is_trapped" = "True" ]; then
        log_trap_access "$name"
    fi
    
    local is_locked=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin).get('locked', False))")
    
    if [ "$is_locked" = "True" ]; then
        echo -e "${RED}Item '$name' is locked. Use 'hide enterKey $name' to unlock${NC}"
        exit 1
    fi
    
    local path=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['path'])")
    local type=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['type'])")
    
    if [ "$type" != "file" ]; then
        echo -e "${RED}Cannot read folder. Use 'hide open $name' instead${NC}"
        exit 1
    fi
    
    if [ ! -f "$path" ]; then
        echo -e "${RED}File not found at: $path${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘  Content of: ${YELLOW}$name${CYAN}                                      â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    cat "$path"
    echo ""
}

# Open hidden item
open_hidden_item() {
    local name="$1"
    local entry=$(get_from_registry "$name")
    
    if [ -z "$entry" ]; then
        echo -e "${RED}Item '$name' not found${NC}"
        exit 1
    fi
    
    # Check if trapped
    local is_trapped=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin).get('trapped', False))")
    if [ "$is_trapped" = "True" ]; then
        log_trap_access "$name"
    fi
    
    local is_locked=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin).get('locked', False))")
    
    if [ "$is_locked" = "True" ]; then
        echo -e "${RED}Item '$name' is locked. Use 'hide enterKey $name' to unlock${NC}"
        exit 1
    fi
    
    local path=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['path'])")
    local type=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['type'])")
    local editor=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['editor'])")
    
    if [ "$type" = "file" ]; then
        if [ "$editor" = "nano" ]; then
            nano "$path"
        else
            hide-notepad "$path"
        fi
    else
        cd "$path" && bash
        echo -e "${GREEN}Exited from hidden folder${NC}"
    fi
}

# Delete hidden item
delete_hidden_item() {
    local name="$1"
    local force="$2"
    local entry=$(get_from_registry "$name")
    
    if [ -z "$entry" ]; then
        echo -e "${RED}Item '$name' not found${NC}"
        exit 1
    fi
    
    local path=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['path'])")
    local type=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['type'])")
    
    if [ "$type" = "folder" ] && [ "$force" != "-f" ]; then
        echo -e "${RED}Cannot delete folder without -f flag${NC}"
        exit 1
    fi
    
    rm -rf "$path"
    remove_from_registry "$name"
    
    echo -e "${GREEN}âœ“ Hidden item '$name' deleted${NC}"
}

# Rename hidden item
rename_hidden_item() {
    local old_name="$1"
    local new_name="$2"
    
    if [ -z "$old_name" ] || [ -z "$new_name" ]; then
        echo -e "${RED}Usage: hide rename <old_name> <new_name>${NC}"
        exit 1
    fi
    
    local entry=$(get_from_registry "$old_name")
    
    if [ -z "$entry" ]; then
        echo -e "${RED}Item '$old_name' not found${NC}"
        exit 1
    fi
    
    if [ -n "$(get_from_registry "$new_name")" ]; then
        echo -e "${RED}Item '$new_name' already exists${NC}"
        exit 1
    fi
    
    update_registry_entry "$old_name" "$new_name"
    
    echo -e "${GREEN}âœ“ Renamed '$old_name' to '$new_name'${NC}"
}

# Lock item with password
lock_item() {
    local name="$1"
    local entry=$(get_from_registry "$name")
    
    if [ -z "$entry" ]; then
        echo -e "${RED}Item '$name' not found${NC}"
        exit 1
    fi
    
    read -sp "Enter password: " password
    echo
    read -sp "Confirm password: " password2
    echo
    
    if [ "$password" != "$password2" ]; then
        echo -e "${RED}Passwords do not match${NC}"
        exit 1
    fi
    
    lock_registry_entry "$name" "$password"
    
    echo -e "${GREEN}âœ“ Item '$name' locked${NC}"
}

# Enter with key (FIXED VERSION)
enter_with_key() {
    local name="$1"
    local entry=$(get_from_registry "$name")
    
    if [ -z "$entry" ]; then
        echo -e "${RED}Item '$name' not found${NC}"
        exit 1
    fi
    
    # Check if trapped
    local is_trapped=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin).get('trapped', False))")
    if [ "$is_trapped" = "True" ]; then
        log_trap_access "$name"
    fi
    
    local is_locked=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin).get('locked', False))")
    
    if [ "$is_locked" != "True" ]; then
        echo -e "${YELLOW}Item '$name' is not locked${NC}"
        open_hidden_item "$name"
        return
    fi
    
    read -sp "Enter password: " password
    echo
    
    if check_password "$name" "$password"; then
        echo -e "${GREEN}âœ“ Password correct${NC}"
        
        local path=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['path'])")
        local type=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['type'])")
        local editor=$(echo "$entry" | python3 -c "import sys, json; print(json.load(sys.stdin)['editor'])")
        
        if [ "$type" = "file" ]; then
            if [ "$editor" = "nano" ]; then
                nano "$path"
            else
                hide-notepad "$path"
            fi
        else
            cd "$path" && bash
            echo -e "${GREEN}Exited from hidden folder${NC}"
        fi
    else
        echo -e "${RED}âœ— Incorrect password${NC}"
        
        # Log failed attempt if trapped
        if [ "$is_trapped" = "True" ]; then
            log_trap_access "$name (FAILED PASSWORD)"
        fi
        
        exit 1
    fi
}

# Open hidden notepad
open_notepad() {
    local name="${1:-untitled}"
    local notepad_file="$HIDE_NOTEPAD_DIR/${name}.txt"
    
    hide-notepad "$notepad_file"
}

# Show help
show_help() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘                    HIDE COMMAND HELP                       â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${GREEN}CREATE:${NC}"
    echo -e "  ${YELLOW}hide${NC}                          Create new hidden file/folder"
    echo ""
    echo -e "${GREEN}LIST:${NC}"
    echo -e "  ${YELLOW}hide ls file${NC}                  List all hidden files"
    echo -e "  ${YELLOW}hide ls folder${NC}                List all hidden folders"
    echo -e "  ${YELLOW}hide ls all${NC}                   List all hidden items"
    echo ""
    echo -e "${GREEN}ACCESS:${NC}"
    echo -e "  ${YELLOW}hide show <n>${NC}                 Show hidden item location"
    echo -e "  ${YELLOW}hide read <n>${NC}                 Read hidden file content"
    echo -e "  ${YELLOW}hide open <n>${NC}                 Open hidden item"
    echo -e "  ${YELLOW}hide notepad <n>${NC}              Open hidden notepad"
    echo ""
    echo -e "${GREEN}ADVANCED:${NC}"
    echo -e "  ${YELLOW}hide matrix <keyword>${NC}        Search by name/content (files=purple, folders=red)"
    echo -e "  ${YELLOW}hide stats${NC}                    Show storage stats for each item"
    echo -e "  ${YELLOW}hide duplicate-check${NC}          Find duplicate files"
    echo -e "  ${YELLOW}hide trap <n>${NC}                 Log access attempts with alerts"
    echo ""
    echo -e "${GREEN}MANAGE:${NC}"
    echo -e "  ${YELLOW}hide delete <n>${NC}               Delete hidden file"
    echo -e "  ${YELLOW}hide delete -f <n>${NC}            Delete hidden folder (force)"
    echo -e "  ${YELLOW}hide rename <old> <new>${NC}       Rename hidden item"
    echo ""
    echo -e "${GREEN}SECURITY:${NC}"
    echo -e "  ${YELLOW}hide key <n>${NC}                  Lock item with password"
    echo -e "  ${YELLOW}hide enterKey <n>${NC}             Unlock and open item"
    echo ""
    echo -e "${GREEN}INFO:${NC}"
    echo -e "  ${YELLOW}hide help${NC}                     Show this help"
    echo ""
}

# Main command handler
main() {
    init_hide_system
    
    if [ $# -eq 0 ]; then
        create_hidden_item
        exit 0
    fi
    
    case "$1" in
        ls)
            if [ "$2" = "file" ]; then
                list_hidden_items "file"
            elif [ "$2" = "folder" ]; then
                list_hidden_items "folder"
            elif [ "$2" = "all" ]; then
                list_hidden_items "all"
            else
                echo -e "${RED}Usage: hide ls [file|folder|all]${NC}"
                exit 1
            fi
            ;;
        show)
            show_hidden_item "$2"
            ;;
        read)
            read_hidden_file "$2"
            ;;
        open)
            open_hidden_item "$2"
            ;;
        matrix)
            matrix_search "$2"
            ;;
        stats)
            show_stats
            ;;
        duplicate-check)
            find_duplicates
            ;;
        trap)
            set_trap "$2"
            ;;
        delete)
            if [ "$2" = "-f" ]; then
                delete_hidden_item "$3" "-f"
            else
                delete_hidden_item "$2" ""
            fi
            ;;
        rename)
            rename_hidden_item "$2" "$3"
            ;;
        key)
            lock_item "$2"
            ;;
        enterKey)
            enter_with_key "$2"
            ;;
        notepad)
            open_notepad "$2"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}Unknown command: $1${NC}"
            echo -e "${YELLOW}Use 'hide help' for usage information${NC}"
            exit 1
            ;;
    esac
}

main "$@"
